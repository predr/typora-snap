# Builds from latest tar release and includes several themes and pandoc.
# https://snapcraft.io/docs/snapcraft-yaml-reference
name: typora
summary: A minimal Markdown reading and writing app
description: |
  Typora is a minimal markdown editor, providing new ways for reading and
  writing markdown. It is currently in beta.

  Typora is commercial software (not open source), but is free during beta.
  Typora on GitHub supports collaboration between its developer, Abner Lee, and
  its user community, providing a place to transparently report issues, collect
  feedback and discuss future direction. It also provides open source resources
  for user customization of themes.

adopt-info: latest
base: core18
grade: stable
confinement: strict
architectures: 
  - build-on: amd64

plugs:
  browser-sandbox:
    allow-sandbox: false
    interface: browser-support

layout:
  /usr/share/pandoc/data:
    bind: $SNAP/usr/share/pandoc/data

apps:
  typora:
    command: wrapper $SNAP/typora/Typora --no-sandbox
    extensions: [gnome-3-28]
    environment:
      DISABLE_WAYLAND: '1'
    plugs:
      - browser-support
      - browser-sandbox
      - desktop
      - desktop-legacy
      - wayland
      - unity7
      - x11
      - opengl
      - home
      - network
      - gsettings
      - audio-playback

parts:
  latest:
    plugin: dump
    source: https://typora.io/linux/Typora-linux-x64.tar.gz
    source-type: tar
    override-build: |
      snapcraftctl build
      snapcraftctl set-version $(cat resources/app/package.json | jq -r .version)
    build-packages:
      - jq
    organize:
      '*': typora/

  wrapper:
    source: scripts
    plugin: dump
    organize:
      wrapper: bin/wrapper
    stage-packages:
      - jq
      - libnspr4
      - libnss3
      - libxss1
      - pandoc
      - pandoc-data

  theme-ash:
    source: https://github.com/typora/typora-ash-theme.git
    plugin: dump
    stage: &theme-remove
      - -README.md
      - -LICENSE
      - -src
      - -demo
      - -Snip2017*.png
      - -thumbnail.png
      - -preview.png
      - -lorem-ipsum.md
    organize:
      ash*: typora/resources/app/style/themes/
    
  theme-monospace:
    source: https://github.com/typora/typora-monospace-theme.git
    plugin: dump
    stage: *theme-remove
    organize:
      monospace*: typora/resources/app/style/themes/

  theme-lostkeys:
    source: https://github.com/typora/Typora-Lostkeys-Theme.git
    plugin: dump
    stage: *theme-remove
    organize:
      theme/lostkeys*: typora/resources/app/style/themes/

  theme-saffron:
    source: https://github.com/Akash-Panigrahi/typora-saffron-theme.git
    plugin: dump
    stage: *theme-remove
    organize:
      saffron*: typora/resources/app/style/themes/

  cleanup:
    after: [latest, wrapper]
    plugin: nil
    build-snaps: [core18, gnome-3-28-1804]
    override-prime: |
      set -eux
      for lib in "libharfbuzz" "libglibmm" "libgiomm" "libQt" "libflite" "qt5"; do
        rm -rf "usr/lib/$SNAPCRAFT_ARCH_TRIPLET/$lib"*
      done
      for cruft in "bug" "lintian" "man" "icons/Humanity"; do
        rm -rf "$SNAPCRAFT_PRIME/usr/share/$cruft"
      done
      find $SNAPCRAFT_PRIME/usr/share/doc/ -type f -not -name 'copyright' -delete
      find $SNAPCRAFT_PRIME/usr/share -type d -empty -delete
      # Remove all files from snap that are already included in the base snap or in
      # any connected content snaps
      for snap in "core18" "gnome-3-28-1804"; do
        cd "/snap/$snap/current" && find . -type f,l -exec rm -f "$SNAPCRAFT_PRIME/{}" \;
      done
      chmod 755 $SNAPCRAFT_PRIME/typora/chrome-sandbox