# Builds from latest tar release and includes several themes and pandoc.
# https://snapcraft.io/docs/snapcraft-yaml-reference
name: typora
summary: A minimal Markdown reading and writing app
description: |
  Typora is a minimal markdown editor, providing new ways for reading and
  writing markdown. It is currently in beta.

  Typora is commercial software (not open source), but is free during beta.
  Typora on GitHub supports collaboration between its developer, Abner Lee,
  and its user community, providing a place to transparently report issues,
  collect feedback and discuss future direction. It also provides open
  source resources for user customization of themes.

adopt-info: typora
base: core18
grade: stable
confinement: strict
architectures: 
  - build-on: amd64

plugs:
  browser-sandbox:
    allow-sandbox: false
    interface: browser-support

layout:
  /usr/share/pandoc/data:
    bind: $SNAP/usr/share/pandoc/data

apps:
  typora:
    command: wrapper $SNAP/typora/Typora --no-sandbox
    extensions: [gnome-3-28]
    environment:
      DISABLE_WAYLAND: '1'
    plugs:
      - browser-support
      - browser-sandbox
      - desktop
      - desktop-legacy
      - wayland
      - unity7
      - x11
      - opengl
      - home
      - network
      - gsettings
      - audio-playback

parts:
  typora:
    source: https://typora.io/linux/Typora-linux-x64.tar.gz
    source-type: tar
    plugin: dump
    override-build: |
      snapcraftctl build
      snapcraftctl set-version $(cat resources/app/package.json | jq -r .version)
    build-packages:
      - jq
    organize:
      '*': typora/

  theme-ash:
    source: https://github.com/typora/typora-ash-theme.git
    plugin: dump
    override-build: cp --recursive ash* $SNAPCRAFT_PART_INSTALL/
    organize:
      ash*: typora/resources/app/style/themes/
    
  theme-monospace:
    source: https://github.com/typora/typora-monospace-theme.git
    plugin: dump
    override-build: cp --recursive monospace* $SNAPCRAFT_PART_INSTALL/
    organize:
      monospace*: typora/resources/app/style/themes/

  theme-lostkeys:
    source: https://github.com/typora/Typora-Lostkeys-Theme.git
    plugin: dump
    override-build: cp --recursive theme/lostkeys* $SNAPCRAFT_PART_INSTALL/
    organize:
      lostkeys*: typora/resources/app/style/themes/

  theme-saffron:
    source: https://github.com/Akash-Panigrahi/typora-saffron-theme.git
    plugin: dump
    override-build: cp --recursive saffron* $SNAPCRAFT_PART_INSTALL/
    organize:
      saffron*: typora/resources/app/style/themes/

  wrapper:
    source: scripts
    plugin: dump
    stage-packages:
      - jq
      - libnspr4
      - libnss3
      - libxss1
      - pandoc
      - pandoc-data

  cleanup:
    after: [typora, wrapper]
    plugin: nil
    build-snaps: [core18, gnome-3-28-1804]
    override-prime: |
      find $SNAPCRAFT_PRIME/usr/share/doc/ -type f -not -name 'copyright' -delete
      find $SNAPCRAFT_PRIME/usr/share/man/ -type f -delete
      find $SNAPCRAFT_PRIME/ -type d -empty -delete
      sudo chown root $SNAPCRAFT_PRIME/typora/chrome-sandbox
      chmod 4755 $SNAPCRAFT_PRIME/typora/chrome-sandbox
